<section>
    <div class="d-flex">
        {{> sidebar}}

        <div class="content col-md-10">
            <h1>Movies Manager</h1>

            <div class="container-admin">
                <!-- Filter Options -->
                <div class="filter-options d-flex justify-content-between">
                    <!-- Search and Filter -->
                    <div>
                        <input type="text" id="filter-name" placeholder="Search by movie name..." class="filter"
                               style="width: 200px;">
                        <select id="filter-genre" class="filter" style="width: 150px;">
                            <option value="all">All Genre</option>
                            {{#each genres}}
                                <option value="{{this}}">{{this}}</option>
                            {{/each}}
                        </select>
                        <select id="filter-country" class="filter" style="width: 150px;">
                            <option value="all">All Country</option>
                            {{#each countries}}
                                <option value="{{this}}">{{this}}</option>
                            {{/each}}
                        </select>
                        <button id="filter-button">Filter</button>
                    </div>

                    <!-- Sort Options -->
                    <div>
                        <label for="sort-by">Sort by:</label>
                        <select id="sort-by" class="filter" style="width: 150px;">
                            <option value="none">None</option>
                            <option value="released_date">Released Date</option>
                            <option value="end_date">End Date</option>
                        </select>
                        <select id="sort-order" class="filter">
                            <option value="asc">Ascending</option>
                            <option value="desc">Descending</option>
                        </select>
                        <button id="sort-button">Sort</button>
                    </div>
                </div>
                <br>

                <!-- Movie Table -->
                <div style="overflow-y: auto; max-height: 500px;">
                    <table id="movie-db" class="table table-striped">
                        <thead>
                        <tr>
                            <th style="width: 25%; position: sticky; top: 0;">Movie Name</th>
                            <th style="width: 10%; position: sticky; top: 0;">Genre</th>
                            <th style="width: 10%; position: sticky; top: 0;">Country</th>
                            <th style="width: 10%; position: sticky; top: 0;">Age</th>
                            <th style="width: 12%; position: sticky; top: 0;">Released Date</th>
                            <th style="width: 12%; position: sticky; top: 0;">End Date</th>
                            <th style="width: 20%; position: sticky; top: 0;">Actions</th>
                        </tr>
                        </thead>
                        <tbody>
                        {{#each movies}}
                            <tr>
                                <td>{{name_vn}}</td>
                                <td>{{type_name_vn}}</td>
                                <td>{{country_name_vn}}</td>
                                <td>{{limitage_vn}}</td>
                                <td>{{release_date}}</td>
                                <td>{{end_date}}</td>
                                <td>
                                    <button>Edit</button>
                                    <button>Delete</button>
                                </td>
                            </tr>
                        {{/each}}
                        </tbody>
                    </table>
                </div>
                <div>
                    <div class="d-flex justify-content-end">
                        <button id="add-movie-button" class="btn btn-success mt-4">Add Movie</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        // Fetch all movies
        const fetchmovies = async () => {
            const response = await fetch("/api/movies");
            console.log(response);
            if (response.ok) {
                const movies = await response.json();
                rendermovies(movies);
            } else {
                alert("Failed to fetch movies.");
            }
        };

        // Render the movies table
        const rendermovies = (movies) => {
            const table = document.getElementById("movie-db").getElementsByTagName("tbody")[0];
            table.innerHTML = "";
            movies.forEach((movie) => {
                const row = table.insertRow(-1);
                row.innerHTML = `
                <td>${movie.name_vn}</td>
                <td>${movie.type_name_vn.join(', ')}</td>
                <td>${movie.country_name_vn}</td>
                <td>${movie.limitage_vn}</td>
                <td>${new Date(movie.release_date).toLocaleDateString()}</td>
                <td>${new Date(movie.end_date).toLocaleDateString()}</td>
                <td>
                    <button class="edit-button">Edit</button>
                    <button class="delete-button">Delete</button>
                </td>
                `;

                // Handle Edit button
                row.querySelector(".edit-button").addEventListener("click", () => {
                    showEditForm(movie);
                });

                // Handle Delete button
                row.querySelector(".delete-button").addEventListener("click", async () => {
                    const confirmDelete = confirm(`Are you sure you want to delete the movie "${movie.name_vn}"?`);
                    if (confirmDelete) {
                        const response = await fetch(`/admin/movies/${movie.id}`, {
                            method: "DELETE"
                        });

                        if (response.ok) {
                            alert("Movie deleted successfully!");
                            location.reload();
                        } else {
                            alert("Error deleting movie.");
                        }
                    }
                });
            });
        };
        // Show the edit form with the current movie details
        const showEditForm = (movie) => {
            const content = document.querySelector(".content");
            content.innerHTML = `
            <div class="content">
                <h1>Edit Movie: ${movie.name_vn}</h1>
                <div class="container-admin">
                    <form id="edit-movie-form" class="form-container-movie-manager">
                        <div class="form-group-movie-manager">
                            <label for="name-vn">Name (VN):</label>
                            <input type="text" id="name-vn" value="${movie.name_vn}">
                        </div>
                        <div class="form-group-movie-manager">
                            <label for="director">Director:</label>
                            <input type="text" id="director" value="${movie.director}">
                        </div>
                        <div class="form-group-movie-manager">
                            <label for="actor">Actor:</label>
                            <input type="text" id="actor" value="${movie.actor}">
                        </div>
                        <div class="form-group-movie-manager">
                            <label for="release-date">Release Date:</label>
                            <input type="date" id="release-date" value="${new Date(movie.release_date).toISOString().split('T')[0]}">
                        </div>
                        <div class="form-group-movie-manager">
                            <label for="country">Country:</label>
                            <input type="text" id="country" value="${movie.country_name_vn}">
                        </div>
                        <div class="form-group-movie-manager">
                            <label for="genre">Genre:</label>
                            <input type="text" id="genre" value="${movie.type_name_vn.join(', ')}">
                        </div>
                        <div class="form-group-movie-manager">
                            <label for="trailer">Trailer:</label>
                            <input type="text" id="trailer" value="${movie.trailer}">
                        </div>
                        <div class="form-group-movie-manager">
                            <label for="ratings">Ratings:</label>
                            <input type="text" id="ratings" value="${movie.ratings}">
                        </div>
                        <div class="form-group-movie-manager">
                            <label for="time">Time (minutes):</label>
                            <input type="number" id="time" value="${movie.time}">
                        </div>
                        <div class="form-group-movie-manager">
                            <label for="brief-vn">Brief (VN):</label>
                            <textarea id="brief-vn" rows="5" style="min-height: 120px; width: 100%;">${movie.brief_vn}</textarea>
                        </div>
                        <div class="form-group-movie-manager">
                            <label for="movie-image">Image:</label>
                            <input type="file" name="movieImage" id="movie-image" accept="image/*">
                            ${movie.image ? `<img src="${movie.image}" alt="Current Image" width="100" height="100">` : ''}
                        </div>
                        <div class="form-group-movie-manager">
                            <label for="background-image">Background Image:</label>
                            <input type="file" name="backgroundImage" id="background-image" accept="image/*">
                            ${movie.background_image_url ? `<img src="${movie.background_image_url}" alt="Current Background Image" width="100" height="100">` : ''}
                            </div>
                        <div class="form-action-movie-manager">
                            <button type="submit" class="btn btn-primary">Save</button>
                            <button type="button" class="btn btn-secondary" id="cancel-edit">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
            `;

            // Initial load (fetch all movies)
            fetchmovies();
        };
    });
</script>